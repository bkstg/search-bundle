{
  "query": {
    "bool": {
      "must": [
        { "query_string": { "query": "{{ query_string }}", "fields": ["{{ fields|join('", "')|raw }}"] } },
        { "bool": {
          "should": [
            {
              "bool": {
                "must_not": { "terms": { "_type": ["production","user"] } },
                "must": [
                  { "term": { "status": 1 } },
                  { "terms": { "groups.id": [{{ group_ids|join(", ") }}] } }
                ]
              }
            },
            {
              "bool": {
                "must": [
                  { "term": { "_type": "production" } },
                  { "term": { "status": 1 } },
                  { "terms": { "id": [{{ group_ids|join(", ") }}] } }
                ]
              }
            },
            {
              "bool": {
                "must": [
                  { "term": { "_type": "user" } },
                  { "term": { "enabled": 1 } },
                  { "terms": { "memberships.group.id": [{{ group_ids|join(", ") }}] } }
                ]
              }
            }
          ]
        }}
      ]
    }
  }
}
